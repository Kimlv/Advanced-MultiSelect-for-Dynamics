var AdvancedMultiSelect=window.AdvancedMultiSelect||{__namespace:!0};AdvancedMultiSelect.ItemSetConfiguration=AdvancedMultiSelect.ItemSetConfiguration||{__namespace:!0};AdvancedMultiSelect.ItemSetConfiguration.Form=function(){var e=!1,o=!1,i,r,ht,ct,u,f,s={BeforeSection:10,AfterSection:20,FirstOnTab:30},t={entityName:null,itemSetName:null,savingAttributeName:null,form:null,tabName:null,sectionName:null,sectionLabel:null,showSectionLabel:null,showSectionLine:null,sectionLocation:null,nearSectionName:null,template:null,numberOfRows:null},n={entityName:null,itemSetName:null,savingAttributeName:null,form:null,tabName:null,sectionName:null,sectionLabel:null,showSectionLabel:null,showSectionLine:null,sectionLocation:null,nearSectionName:null,template:null,numberOfRows:null,newSectionName:null},lt=function(){i=Xrm.Page;r=AdvancedMultiSelect.FormUtils;ht=AdvancedMultiSelect.AdvFindUtils;ct=AdvancedMultiSelect.XmlUtils},at=function(){t.entityName=i.getControl("pavelkh_entityname");t.itemSetName=i.getControl("pavelkh_itemsetname");t.savingAttributeName=i.getControl("pavelkh_dummysavingfield");t.form=i.getControl("pavelkh_addtoform");t.tabName=i.getControl("pavelkh_addtotab");t.sectionName=i.getControl("pavelkh_newsectionname");t.sectionLabel=i.getControl("pavelkh_sectionlabel");t.showSectionLabel=i.getControl("pavelkh_showsectionlabel");t.showSectionLine=i.getControl("pavelkh_showsectionline");t.sectionLocation=i.getControl("pavelkh_newsectionlocation");t.nearSectionName=i.getControl("pavelkh_addnearsection");t.template=i.getControl("pavelkh_webresource");t.numberOfRows=i.getControl("pavelkh_numberofrows");n.entityName=t.entityName.getAttribute();n.itemSetName=t.itemSetName.getAttribute();n.savingAttributeName=t.savingAttributeName.getAttribute();n.form=t.form.getAttribute();n.tabName=t.tabName.getAttribute();n.sectionName=t.sectionName.getAttribute();n.sectionLabel=t.sectionLabel.getAttribute();n.showSectionLabel=t.showSectionLabel.getAttribute();n.showSectionLine=t.showSectionLine.getAttribute();n.sectionLocation=t.sectionLocation.getAttribute();n.nearSectionName=t.nearSectionName.getAttribute();n.template=t.template.getAttribute();n.numberOfRows=t.numberOfRows.getAttribute();n.newSectionName=i.getAttribute("pavelkh_newsectionname");n.form.setSubmitMode("never");n.tabName.setSubmitMode("never");n.sectionName.setSubmitMode("never");n.sectionLabel.setSubmitMode("never");n.showSectionLabel.setSubmitMode("never");n.showSectionLine.setSubmitMode("never");n.sectionLocation.setSubmitMode("never");n.nearSectionName.setSubmitMode("never");n.template.setSubmitMode("never");n.numberOfRows.setSubmitMode("never")},vt=function(n){if(!n)return null;for(var t=0;t<f.length;t++)if(f[t].Name===n)return f[t];return null},h=function(n){if(!n)return null;n=n.trim().toLowerCase();for(var t=0;t<u.length;t++)if(u[t].FullName.trim().toLowerCase()===n)return u[t];return null},a=function(n,t){var i=h(n,t);return i?i.Tabs:[]},v=function(n,t){var r=a(n),i;if(r.length===0||!t)return null;for(t=t.trim().toLowerCase(),i=0;i<r.length;i++)if(r[i].Name.trim().toLowerCase()===t)return r[i];return null},y=function(n,t){var i=v(n,t);return i?i.Sections:[]},yt=function(n,t,i){var u=y(n,t),r;if(!u)return null;for(i=i.trim(),r=0;r<u.length;r++)if(u[r].Name.trim()===i)return u[r];return null},c=function(n){t.form.setDisabled(n);t.tabName.setDisabled(n);t.sectionName.setDisabled(n);t.sectionLabel.setDisabled(n);t.showSectionLabel.setDisabled(n);t.showSectionLine.setDisabled(n);t.sectionLocation.setDisabled(n);t.nearSectionName.setDisabled(n);t.template.setDisabled(n);t.numberOfRows.setDisabled(n)},l=function(n,t){var r="AddingControlError";n?i.ui.setFormNotification(t,"ERROR",r):i.ui.clearFormNotification(r)},p=function(n,t){var r="AddingControlComplete";n?i.ui.setFormNotification(t,"INFO",r):i.ui.clearFormNotification(r)},pt=function(){return e},wt=function(){e=!0;r.ShowWaitingNotification("Loading metadata",pt,200,"Loading metadata, please wait")},w=function(){e=!1},b=function(){return o},bt=function(){o=!0;c(!0);r.ShowWaitingNotification("Adding Control",b,200,"MultiSelect control is being added on the form, please wait")},k=function(){c(!1);o=!1},kt=function(n){var t="An error occurred while getting metadata.";i.ui.setFormNotification(t,"ERROR","MetadataLoadError");Xrm.Utility.alertDialog(t+"\nDetails:\n"+n.message)},dt=function(){var t=xrmjQuery.Deferred(),i={EntityLogicalName:n.entityName.getValue()};return CrmWebApiFacade.ExecuteAction("pavelkh_ItemSetConfigurationGetAddControlWizardData",i).then(function(n){u=JSON.parse(n.FormList);f=JSON.parse(n.TemplateList);t.resolve()},function(n){t.reject(n)}),t.promise()},d=function(){return r.ValidateAutocomplete(t.form,function(n){var t=h(n);return!!t&&t.FullName.toLowerCase()===n.toLowerCase()})},g=function(){return r.ValidateAutocomplete(t.tabName,function(t){var i=v(n.form.getValue(),t);return!!i&&i.Name.toLowerCase()===t.toLowerCase()})},gt=function(){return!!n.sectionName.getValue()},ni=function(){return!!n.sectionLabel.getValue()},ti=function(){return n.showSectionLabel.getValue()!=null},ii=function(){return n.showSectionLine.getValue()!=null},nt=function(){return r.ValidateAutocomplete(t.nearSectionName,function(t){var i=yt(n.form.getValue(),n.tabName.getValue(),t);return!!i&&i.Name.toLowerCase()===t.toLowerCase()})},tt=function(){return r.ValidateAutocomplete(t.template,function(n){var t=vt(n);return!!t})},ri=function(){var t=n.numberOfRows.getValue();return t!=null&&t>0&&t<51},ui=function(){var r=n.sectionLocation.getValue(),i=r===s.AfterSection||r===s.BeforeSection;n.nearSectionName.setRequiredLevel(i?"required":"none");i||n.nearSectionName.getValue()||n.nearSectionName.setValue(null);t.nearSectionName.setVisible(i)},fi=function(){tt()},it=function(){nt()},rt=function(){g();it()},ei=function(){d();rt()},ut=function(){r.ShowAutocomplete(t.template,f,function(n,t){var i=f[t],r=i.Name,u=i.DisplayName,e=n.length===0||r.indexOf(n.toLowerCase())>=0;return e?{id:t,fields:[r,u],icon:"/_imgs/ico_16_9333.gif"}:null})},ft=function(){r.ShowAutocomplete(t.form,u,function(n,t){var i=u[t],r=i.FullName.toLowerCase(),f=i.Description,e=n.length===0||r.indexOf(n.toLowerCase())>=0;return e?{id:t,fields:[r,f],icon:"/_imgs/ico_16_forms.png"}:null})},et=function(){var u=n.form.getValue(),i=a(u);r.ShowAutocomplete(t.tabName,i,function(n,t){var r=i[t],u=r.Name,f=r.DisplayName,e=n.length===0||u.toLowerCase().indexOf(n.toLowerCase())>=0||f.toLowerCase().indexOf(n.toLowerCase())>=0;return e?{id:t,fields:[u,f]}:null})},ot=function(){var u=n.form.getValue(),f=n.tabName.getValue(),i=y(u,f);r.ShowAutocomplete(t.nearSectionName,i,function(n,t){var r=i[t],u=r.Name,f=r.DisplayName,e=n.length===0||u.toLowerCase().indexOf(n.toLowerCase())>=0||f.toLowerCase().indexOf(n.toLowerCase())>=0;return e?{id:t,fields:[u,f]}:null})},oi=function(){t.form.addOnKeyPress(ft);t.tabName.addOnKeyPress(et);t.nearSectionName.addOnKeyPress(ot);t.template.addOnKeyPress(ut)},si=function(){wt();var n=xrmjQuery.Deferred();return dt().then(function(){w();n.resolve()},function(t){w();n.reject(t)}),n.promise()},hi=function(){i.ui.setFormNotification("Save is disabled for this form.","INFO","autosaveinfo")},ci=function(){try{r.GetInputElemByControl(t.form).onfocus=function(){ft()};r.GetInputElemByControl(t.tabName).onfocus=function(){et()};r.GetInputElemByControl(t.nearSectionName).onfocus=function(){ot()};r.GetInputElemByControl(t.template).onfocus=function(){ut()}}catch(n){}},li=function(){t.form.setFocus()},ai=function(){n.form.setRequiredLevel("required");n.tabName.setRequiredLevel("required");n.sectionName.setRequiredLevel("required");n.sectionLabel.setRequiredLevel("required");n.showSectionLabel.setRequiredLevel("required");n.showSectionLine.setRequiredLevel("required");n.sectionLocation.setRequiredLevel("required");n.nearSectionName.setRequiredLevel("required");n.template.setRequiredLevel("required");n.numberOfRows.setRequiredLevel("required")},vi=function(){n.sectionLocation.setValue(s.BeforeSection);n.numberOfRows.setValue(8)},st=function(){for(var t,u=i.ui.formSelector,r=u.items.get(),n=0;n<r.length;n++)if(t=r[n],t.getId().toUpperCase()==="45281719-08EE-40E5-ADAD-0F264D571548"){t.navigate();return}},yi=function(){var n=i.context.getQueryStringParameters();return n.parameter_validopen?!0:(st(),!1)},pi=function(){(lt(),at(),yi())&&(vi(),si().then(function(){hi();ai();c(!1);oi();ci();li()},function(n){kt(n)}))},wi=function(){var t=xrmjQuery.Deferred(),i=h(n.form.getValue()),r={EntityLogicalName:n.entityName.getValue(),ItemSetName:n.itemSetName.getValue(),DummySavingAttributeName:n.savingAttributeName.getValue(),FormId:i.Id,TabName:n.tabName.getValue(),NewSectionLocation:n.sectionLocation.getValue(),NearSectionName:n.nearSectionName.getValue(),WebResource:n.template.getValue(),NewSectionName:n.sectionName.getValue(),NewSectionLabel:n.sectionLabel.getValue(),ShowLabel:n.showSectionLabel.getValue(),ShowLine:n.showSectionLine.getValue(),NumberOfRows:n.numberOfRows.getValue()};return CrmWebApiFacade.ExecuteAction("pavelkh_ItemSetConfigurationAddControlOnForm",r).then(function(){t.resolve()},function(n){t.reject(n)}),t.promise()},bi=function(){return d()&&g()&&gt()&&ni()&&ti()&&ii&&nt()&&tt()&&ri()},ki=function(){if(b())return!1;if(l(!1),p(!1),!bi())return l(!0,"Please provide correct values for the required fields."),!1;bt();var n=xrmjQuery.Deferred();return wi().then(function(){var t="The MultiSelect control has been successfully added on the form. You can also add the control on another form as needed.";k();p(!0,t);Xrm.Utility.alertDialog(t);n.resolve()},function(t){k();n.reject(t);var i="An error occured while adding the MultiSelect control to the form. Details: "+t.message;l(!0,i);Xrm.Utility.alertDialog(i)}),n.promise()},di=function(n){var t=n.getEventArgs();return t.preventDefault(),!1},gi=function(){var t=n.newSectionName.getValue();t!=null&&(t=t.replace(/[^a-zA-Z0-9]/g,""),n.newSectionName.setValue(t))},nr=function(){gi()};return{OnFormLoad:pi,OnFormSave:di,OnFormChange:ei,OnTabChange:rt,OnNewSectionNameChange:nr,OnSectionLocationChange:ui,OnNearSectionChange:it,OnTemplateChange:fi,AddAdvancedMultiSelectControlOnForm:ki,NavigateToMainForm:st}}();