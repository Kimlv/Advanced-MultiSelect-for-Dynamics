(function(n,t,i){window.AdvancedMultiSelectControl=function(){function u(n){var t,i,r;if(location.search!==""){t=location.search.substr(1).split("&");for(i in t)t.hasOwnProperty(i)&&(t[i]=t[i].replace(/\+/g," ").split("="));for(r in t)if(t.hasOwnProperty(r)&&t[r][0].toLowerCase()===n.toLowerCase())return t[r][1]}return""}function f(){var f=u("data"),i,n,r,t,e;if(f==null)return null;i={};n=decodeURIComponent(f).split("&");for(r in n)n.hasOwnProperty(r)&&(t=n[r].replace(/\+/g," ").split("="),t[0]&&(e=t[0].trim().toLowerCase(),i[e]=t[1]));return i}var r=window.parent.Xrm.Page,t={FORM_TYPE_CREATE:1,FORM_TYPE_UPDATE:2,FORM_TYPE_READ_ONLY:3,FORM_TYPE_DISABLED:4,FORM_TYPE_BULK_EDIT:6},e=function(e){var o=this;o.DataLoaded=ko.observable(!1);o.ItemSet=ko.observableArray([]);o.ItemSetSelected=ko.observableArray([]);o.ItemSetByRows=ko.observableArray([]);o.ColumnCount=ko.observable(parseInt(e)||1);o.SavingAttr=null;o.Items=null;o.ErrorMessage=ko.observable(null);o.ModeMessage=ko.observable(null);o.AllowUpdate=ko.observable(!1);o.ReadOnlyMode=ko.observable(!0);o.Visible=ko.observable(!0);o.SelectizeMode=ko.observable(!1);var s=function(){var i=[],t,n,r;if(o.SelectizeMode())for(t=o.ItemSetSelected(),n=0,r=t.length;n<r;n++)i.push(t[n]);else for(t=o.ItemSet(),n=0,r=t.length;n<r;n++)t[n].Value()&&i.push(t[n].Id);return i.length===0?"-":i.join(";")},c=function(){var n=s();o.SavingAttr.setSubmitMode("always");o.SavingAttr.setValue(n)},l=function(){var n=o.SavingAttr.getValue();return n==null||n===""?null:n==="-"?[]:n.split(";")},a=function(t,u,f){var e=n.Deferred(),s={EntityLogicalName:u,RecordId:t,ItemSetName:f};return i.ExecuteAction("pavelkh_GetItemSet",s).then(function(n){o.SavingAttr=r.getAttribute(n.SavingAttributeLogicalName);o.SavingAttr||e.reject(n.SavingAttributeLogicalName+" hidden dummy saving attribute is expected to be on the form but is not found on it.");o.Items=JSON.parse(n.Items);o.AllowUpdate(JSON.parse(n.AllowUpdate));e.resolve()},e.reject),e.promise()},v=function(){var t=n.Deferred(),e=u("typename"),o,r,i;return e?(o=decodeURIComponent(u("id")),r=f(),!r)?(t.reject({message:"Error! Data parameters is not provided to the checkbox set control."}),t.promise()):(i=r.itemsetname,!i)?(t.reject({message:"Error! Data parameters provided to the multiselect set control are invalid."}),t.promise()):(i=i.replace(/"/g,""),a(o,e,i).then(function(){t.resolve()},t.reject),t.promise()):(t.reject({message:"Error! Entity type is not provided to the checkbox set control."}),t.promise())},y=function(){if(!r.ui){o.Visible(!1);return}switch(r.ui.getFormType()){case t.FORM_TYPE_CREATE:case t.FORM_TYPE_UPDATE:case t.FORM_TYPE_READ_ONLY:case t.FORM_TYPE_DISABLED:o.Visible(!0);break;default:o.Visible(!1)}},h=function(){var n;if(o.AllowUpdate())switch(r.ui.getFormType()){case t.FORM_TYPE_CREATE:n=!o.SavingAttr.getUserPrivilege().canCreate;break;case t.FORM_TYPE_UPDATE:n=!o.SavingAttr.getUserPrivilege().canUpdate;break;case t.FORM_TYPE_READ_ONLY:case t.FORM_TYPE_DISABLED:n=!0;break;default:n=!0}else n=!0;o.ReadOnlyMode(n)},p=function(){try{var n=r.ui.getFormType();setTimeout(function(){var t=r.ui.getFormType();t!==n&&h()},1e3)}catch(t){}},w=function(){try{r.data.entity.addOnSave(p)}catch(n){}};o.Initialize=function(){w();var t=n.Deferred();return(y(),!o.Visible())?(o.ModeMessage("The content of this section is not available in such form mode."),o.DataLoaded(!0),t.resolve(),t.promise()):(v().then(function(){var w=o.SelectizeMode(),v=l(),b=!!v,k,u,e,d,i,y,p,g,nt,a,r,tt,f,it;for(h(),k=b?n(v):null,u=[],e=0,d=o.Items.length;e<d;e++)i=o.Items[e],y=v?n.inArray(i.Id,k)>-1:i.Selected,w?y&&o.ItemSetSelected.push(i.Id):(p=ko.observable(y),p.subscribe(c),i.Value=p),u.push(i);if(o.ItemSet=ko.observableArray(u),g=b?"always":"never",o.SavingAttr.setSubmitMode(g),nt=s(),o.SavingAttr.setValue(nt),!w){for(a=[],tt=o.ColumnCount(),f=0,it=u.length;f<it;f++)f%tt==0&&(r&&a.push(r),r=[]),r.push(u[f]);r&&a.push(r);o.ItemSetByRows=ko.observableArray(a)}o.DataLoaded(!0);t.resolve()},function(n){var i;i=n?n.message?"Error: "+n.message:n.toString():"There is no error details.";o.DataLoaded(!0);o.ErrorMessage(i);t.reject(n)}),t.promise())};o.SetItemSetSelected=function(n){o.ItemSetSelected(n);var t=s();o.SavingAttr.setSubmitMode("always");o.SavingAttr.setValue(t)}};return{ViewModel:e}}()})(window.xrmjQuery,window.xrmjQuery,window.CrmWebApiFacade);